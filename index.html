<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cupcats Official Rarity Rankings</title>
    <link rel="icon" href="https://cupcatnft.com/cat3.ico" type="image/x-icon"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script type="text/javascript"
            src="//cdnjs.cloudflare.com/ajax/libs/jquery.lazy/1.7.10/jquery.lazy.min.js"></script>

    <style>
        body {
            background-color: #E5A4FF;
        }

        .page-container {
            background-image: url(https://www.cupcatnft.com/BG2.png);
            background-position: 0px 0px;
            background-size: contain;
            background-repeat: repeat;
            background-attachment: fixed;
            display: flex;
            flex-wrap: nowrap;
            height: 100vh;
            max-height: 100vh;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .card {
            margin: .5em auto .5em;
            height: calc(100% - 1em);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

<div class="page-container">
    <div class="d-flex flex-column flex-shrink-0 p-3 bg-light" style="width: 280px;">
        <span class="d-flex align-items-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
            <span class="fs-6">Cupcats Official Rarity Rankings</span>
        </span>
        <hr>
        <div class="flex-column mb-auto">
            <form id="searchForm" class="d-flex">
                <input class="form-control me-2" id="query" type="number" placeholder="Find Cupcat By ID..."
                       aria-label="Search">
                <button class="btn btn-secondary" type="submit">Find</button>
            </form>
            <div id="current-searches" class="mt-2"></div>
        </div>
        <hr>
        <button class="btn btn-primary" id="clear-filters" disabled type="button">Clear Filters</button>
    </div>
    <div class="d-flex flex-column flex-grow-1">
        <div class="container-fluid" style="overflow: auto;">
            <div id="cupcat-container" class="row">
            </div>
        </div>
    </div>
    <!--<nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <form id="searchForm" class="d-flex">
                <input class="form-control-lg me-2" id="query" type="search" placeholder="Search and press Enter"
                       aria-label="Search">
                <button class="btn btn-lg btn-secondary" type="submit">Search</button>
            </form>
            <span class="navbar-text d-none d-lg-inline"><strong>Cupcats Official Rarity Rankings</strong></span>
            <ul class="pagination pagination-lg" style="margin-bottom: 0px;">
                <li class="page-item disabled" id="previous">
                    <a class="page-link" href="#" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                        <span class="sr-only">Previous</span>
                    </a>
                </li>
                <li class="page-item" id="next">
                    <a class="page-link" href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                        <span class="sr-only">Next</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>-->
</div>

<script>
    (function ($) {
        const createTemplate = cupcat => `
            <div class="col" style="max-width: 325px;">
                <div class="card" style="width: 256px;">
                    <img src="${cupcat.image}" class="card-img-top" alt="${cupcat.name}" loading=lazy>
                    <div class="card-body">
                        <h5 class="card-title">${cupcat.name}</h5>
                        <p class="card-text">
                            Rank <strong>#${cupcat.rank}</strong> <br>
                            Score: ${cupcat.value}
                        </p>
                        <p style="display: ${!!cupcat.owner ? 'block' : 'none'}">
                            Owner: ${cupcat.owner}
                            <span style="display: block; visibility: ${!!cupcat.price ? 'visible' : 'hidden'}">
                                Price: <strong>${cupcat.price}</strong> ETH
                            </span>
                        </p>
                        <a href="https://opensea.io/assets/0x8cd8155e1af6ad31dd9eec2ced37e04145acfcb3/${cupcat.name.replace('Cupcat ', '')}"
                            target="_blank"
                           class="btn btn-primary">View On OpenSea</a>
                    </div>
                </div>
            </div>`;

        const searchTemplate = search => `
            <a href="#" data-val="${search}" class="search-param" style="text-decoration: none;">
                <span class="badge bg-primary p-2 mb-2">
                    ${search}&nbsp;&nbsp;&nbsp;&nbsp;
                    <strong>X</strong>
                </span>
            </a>
        `;

        let lastValue = 0;
        let currentRank = 1;
        let cupcats = [];
        let cupcatsCannoncial = [];
        let filteredCats = [];
        let currentPage = 0;

        $.ajaxSetup({cache: false});
        $.getJSON('sorted.json', data => {
            data.rarity.forEach((cupcat, i) => {
                cupcat.assetId = cupcat.name.replace('Cupcat ', '');
                if (cupcat.value === lastValue) {
                    cupcat.rank = currentRank;
                } else {
                    cupcat.rank = i + 1;
                    currentRank = cupcat.rank;
                    lastValue = cupcat.value;
                }
            });

            cupcats = data.rarity;
            cupcatsCannoncial = cupcats.slice();
            selectPage(currentPage);
        });

        $('#previous').click(() => {
            if (!$('#previous').hasClass('disabled')) {
                selectPage(--currentPage);
            }
        });
        $('#next').click(() => {
            if (!$('#next').hasClass('disabled')) {
                selectPage(++currentPage);
            }
        });

        // remove a filter item
        $(document).on('click', '.search-param', function() {
            filteredCats = filteredCats.filter(filter => filter != $(this).data('val'));
            console.info($(this).data('val'), filteredCats);
            buildFilteredCats();
        });
        $('#clear-filters').click(() => {
            filteredCats = [];
            buildFilteredCats();
        });
        $('#searchForm').submit(event => {
            let query = $('#query').val();
            if(query) {
                filteredCats.push(query);
            }
            buildFilteredCats();
            event.preventDefault();
            return false;
        });

        function buildFilteredCats() {
            if(filteredCats.length) {
                cupcats = cupcatsCannoncial.filter(cupcat => {
                    return filteredCats.indexOf(cupcat.assetId) > -1;
                });
            } else {
                cupcats = cupcatsCannoncial.slice();
            }

            $('#current-searches').empty();
            filteredCats.forEach(query => {
                $('#current-searches').append(searchTemplate(query));
            });
            $('#clear-filters').prop('disabled', !filteredCats.length);
            $('#query').val('');
            currentPage = 0;
            selectPage(currentPage);
        }

        function selectPage(pageNumber) {
            const pageCats = [];
            $('#cupcat-container').empty();
            $('#previous').toggleClass('disabled', pageNumber === 0);
            $('#next').toggleClass('disabled', ((pageNumber * 30) + 30) >= cupcats.length);
            for (let i = pageNumber * 30; i < ((pageNumber * 30) + 30) && i < (cupcats.length); i++) {
                pageCats.push(cupcats[i]);
            }

            getOpenSeaInfo(pageCats, function() {
                pageCats.forEach(cupcat => {
                    $('#cupcat-container').append(createTemplate(cupcat));
                });
            });
        }

        function getOpenSeaInfo(pageCats, callback) {
            $.get(
                {
                    url: 'https://api.opensea.io/api/v1/assets',
                    data: {
                        'asset_contract_address': '0x8cd8155e1af6ad31dd9eec2ced37e04145acfcb3',
                        'limit': 30,
                        'token_ids': pageCats.map(cupcat => cupcat.assetId)
                    },
                    traditional: true,
                    cache: true
                }
            ).done(function (response) {
                const responseMap = {};
                if(response.assets) {
                    response.assets.forEach(asset => {
                        responseMap[asset.token_id] = asset;
                    })

                    pageCats.forEach(cupcat => {
                        const osData = responseMap[cupcat.assetId];
                        if (osData) {
                            cupcat.owner = osData.owner.user ? osData.owner.user.username : '';

                            if(!cupcat.owner) {
                                cupcat.owner = osData.owner.address.substring(0, 6) + '...' + osData.owner.address.slice(-4);
                            }

                            if(osData.sell_orders && osData.sell_orders.length) {
                                const forSale = osData.sell_orders[0];

                                // ETH
                                if(forSale.payment_token === '0x0000000000000000000000000000000000000000') {
                                    cupcat.price = (forSale.base_price * .000000000000000001).toFixed(4).replace(/\.0+$/,'');
                                }
                            }
                        }
                    })
                }

                callback();
            }).fail(function() {
                callback();
            });
        }

    })(jQuery);
</script>
</body>
</html>
